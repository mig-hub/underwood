// Copyright (c) 2010 Mickael Riga - See MIT_LICENCE for details
// Version 1

;(function($){$.fn.underwood=function(j){var k={toolbar:"title bold italic link mailto unlink source"};var l=$.extend({},k,j);if(document.designMode||document.contentEditable){return this.each(function(){$(this).parents('form').unbind('submit.underwood').bind('submit.underwood',function(){$(this).find('iframe.underwood_iframe').each(function(){disable_design_mode(this,true)})});enable_design_mode($(this))})}function enable_design_mode(a){var b=document.createElement("iframe");b.frameBorder=0;b.frameMargin=0;b.framePadding=0;b.height=200;b.className="underwood_iframe";if(a.attr('name'))b.rel=a.attr('name');a.after(b);var c="			<style type='text/css'>			.underwood_frame_body {font-family:sans-serif;font-size:12px;margin:0;width:100%;height:100%;}			.underwood_frame_body p {border:1px #DDD solid;padding:2px;}			.underwood_textarea_copy {width:350px;margin:0;padding:0;height:160px;border:1px #999 solid;clear:both;}			.underwood_toolbar {overflow:hidden;}			.underwood_toolbar a, .underwood_toolbar a img {border:0;}			.underwood_toolbar p {float:left;margin:0;padding-right:5px;}			</style>";var d=a.val();if($.trim(d)=='')d='<br>';var e="<html><head>"+c+"</head><body class='underwood_frame_body'>"+d+"</body></html>";try_enable_design_mode(b,e,function(){$(b).prevAll('.underwood_toolbar').remove().end().before(toolbar(b));a.remove()})}function try_enable_design_mode(a,b,c){try{a.contentWindow.document.open();a.contentWindow.document.write(b);a.contentWindow.document.close()}catch(error){console.log(error)}if(document.contentEditable){a.contentWindow.document.designMode="On";c();return true}else if(document.designMode!=null){try{a.contentWindow.document.designMode="on";c();return true}catch(error){console.log(error)}}setTimeout(function(){try_enable_design_mode(a,b,c)},250);return false}function toolbar(c){var d=$("<div class='underwood_toolbar'></div>");var e=l.toolbar.split(' ');for(var i in e){var f=e[i];var g=f.charAt(0).toUpperCase()+f.substr(1).toLowerCase();var h="<a href='#' class='underwood_btn underwood_btn_"+f+"' title='"+g+"'>"+g+"</a>";d.append($(h))}$('.underwood_btn_title',d).click(function(){exec_command(c,"formatblock",'<h3>');return false});$('.underwood_btn_bold',d).click(function(){exec_command(c,'bold');return false});$('.underwood_btn_italic',d).click(function(){exec_command(c,'italic');return false});$('.underwood_btn_link',d).click(function(){var a=prompt("URL:","http://");var b=confirm('Open in a new window? (press cancel to open in the same window)')?'_blank':'_self';if(a)create_targeted_link(c,a,b);return false});$('.underwood_btn_mailto',d).click(function(){var a='mailto:'+prompt("Email address:");if(a)exec_command(c,'CreateLink',a);return false});$('.underwood_btn_unlink',d).click(function(){exec_command(c,'unlink');return false});$('.underwood_btn_image',d).click(function(){var a=prompt("Image URL:");if(a)exec_command(c,'InsertImage',a);return false});$('.underwood_btn_source',d).click(function(){var a=disable_design_mode(c);var b=$("<a href='#' class='underwood_btn underwood_btn_back'>Back to Rich Text Editor</a>");d.empty().append(b);b.click(function(){enable_design_mode(a);return false}).hover(function(){$(this).css('opacity',0.6)},function(){$(this).css('opacity',1)});return false});$('.underwood_btn',d).hover(function(){$(this).css('opacity',0.6)},function(){$(this).css('opacity',1)});return d}function exec_command(a,b,c){a.contentWindow.focus();try{a.contentWindow.document.execCommand(b,false,c)}catch(e){console.log(e)}a.contentWindow.focus()}function disable_design_mode(a,b){var c=a.contentWindow.document.getElementsByTagName("body")[0].innerHTML;if(b==true)var d=$('<input type="hidden" />');else var d=$('<textarea cols="40" rows="10"></textarea>');d.val(c);t=d.get(0);t.className="underwood_textarea_copy";if(a.rel)t.name=a.rel;$(a).before(d);if(b!=true)$(a).remove();return d}function create_targeted_link(a,b,c){selected=a.contentWindow.document.getSelection().getRangeAt(0);var d=a.contentWindow.document.createElement('a');d.href=b;d.target=c;if(selected.toString()==''){d.innerHTML=b;selected.insertNode(d)}else{selected.surroundContents(d)}}}})(jQuery);